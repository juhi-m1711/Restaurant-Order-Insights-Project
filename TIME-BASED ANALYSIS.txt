-- TIME-BASED ANALYSIS
-- 1. Busiest Hour of the Day
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
BUSIEST_HOUR AS(
	SELECT 
	EXTRACT(HOUR FROM ORDER_TIME) AS HOURS,
	COUNT(*) AS TOTAL_ORDERS
	FROM BASE_ORDER
	GROUP BY HOURS
)
SELECT * 
FROM BUSIEST_HOUR 
ORDER BY TOTAL_ORDERS DESC
LIMIT 1;

-- 2. Lunch v/s Dinner Comparison
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
MEAL_TIME AS(
	SELECT 
		CASE 
		WHEN EXTRACT(HOUR FROM ORDER_TIME) BETWEEN 11 AND 15 THEN 'Lunch'
		WHEN EXTRACT(HOUR FROM ORDER_TIME) BETWEEN 18 AND 23 THEN 'Dinner'
		ELSE 'Other'
	END AS MEAL_TIME,
	COUNT(*) AS TOTAL_ITEMS
	FROM BASE_ORDER
	GROUP BY MEAL_TIME
)
SELECT *
FROM MEAL_TIME 
ORDER BY TOTAL_ITEMS DESC;
