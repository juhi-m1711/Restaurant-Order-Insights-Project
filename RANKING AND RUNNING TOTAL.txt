-- RANKING AND RUNNING TOTAL
-- 1. Ranking Items by Revenue within Category
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
ITEM_REVENUE AS (
	SELECT 
	CATEGORY,
	ITEM_NAME,
	SUM(PRICE) AS REVENUE
	FROM 
	BASE_ORDER 
	GROUP BY CATEGORY, ITEM_NAME
)
SELECT 
	CATEGORY,
	ITEM_NAME,
	REVENUE,
	RANK() OVER (
		PARTITION BY CATEGORY 
		ORDER BY REVENUE DESC
	) AS CATEGORY_RANK
FROM ITEM_REVENUE;

-- 2. Running Total of Daily Revenue
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
DAILY_REVENUE AS(
	SELECT 
	ORDER_DATE,
	SUM(PRICE) AS REVENUE
	FROM BASE_ORDER
	GROUP BY ORDER_DATE
)
SELECT 
	ORDER_DATE,
	REVENUE,
	SUM(REVENUE) OVER (ORDER BY ORDER_DATE) AS RUNNING_TOTAL
FROM DAILY_REVENUE;