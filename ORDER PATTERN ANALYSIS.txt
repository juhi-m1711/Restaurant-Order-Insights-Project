-- ORDER PATTERN ANALYSIS
-- I. ORDER VOLUME TRENDS
-- 1. Orders per day 
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
DAILY_ORDERS AS(
	SELECT 
	ORDER_DATE,
	COUNT(DISTINCT ORDER_ID) AS TOTAL_ORDERS
	FROM BASE_ORDER
	GROUP BY
	ORDER_DATE
)
SELECT * 
FROM DAILY_ORDERS 
ORDER BY ORDER_DATE;

-- 2. Orders per hour
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
HOURLY_ORDER AS (
	SELECT 
	EXTRACT(HOUR FROM ORDER_TIME) AS HOURS,
	COUNT(DISTINCT ORDER_ID) AS TOTAL_ORDERS
	FROM 
	BASE_ORDER
	GROUP BY HOURS
)
SELECT * 
FROM HOURLY_ORDER
ORDER BY HOURS;

SELECT * FROM ORDER_DETAILS;

-- II. AVERAGE ORDER SIZE
-- 1. Average items per order
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
AVERAGE_ITEMS AS (
	SELECT 
	ORDER_ID,
	COUNT(*) AS ITEM_COUNT
	FROM BASE_ORDER 
	GROUP BY ORDER_ID
)
SELECT 
	ROUND( AVG(ITEM_COUNT), 2 ) AS AVERAGE_ITEMS_PER_ORDER
FROM AVERAGE_ITEMS;

-- 2. Average Bill Value
WITH BASE_ORDER AS (
	SELECT
		OD.ORDER_DETAILS_ID,
		OD.ORDER_ID,
		OD.ORDER_DATE,
		OD.ORDER_TIME,
		OD.ITEM_ID,
		MI.MENU_ITEM_ID,
		MI.ITEM_NAME,
		MI.CATEGORY,
		MI.PRICE
	FROM 
	ORDER_DETAILS AS OD
	JOIN 
	MENU_ITEMS AS MI 
	ON
	OD.ITEM_ID = MI.MENU_ITEM_ID
),
AVERAGE_BILL_VALUE AS(
	SELECT 
	ORDER_ID,
	SUM(PRICE) AS AVERAGE_ORDER_VALUE
	FROM 
	BASE_ORDER
	GROUP BY ORDER_ID
)
SELECT 
	ROUND(AVG(AVERAGE_ORDER_VALUE),2) AS AVERAGE_BILL_VALUE
FROM 
	AVERAGE_BILL_VALUE;